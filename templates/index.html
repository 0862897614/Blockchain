
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Explorer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_io/favicon.ico') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚õìÔ∏è Blockchain Explorer</h1>
            <p>Kh√°m ph√° v√† l∆∞u tr·ªØ v·ªõi blockchain m·ªôt c√°ch tr·ª±c quan</p>
            <button onclick="toggleInstruction()" class="instruction-btn">‚ùì H∆∞·ªõng d·∫´n</button>
            <div class="instruction" id="instructionBox" style="display: none;">
                <strong>üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong> 
                <ol>
                    <li>ƒêi·ªÅn th√¥ng tin giao d·ªãch (Ng∆∞·ªùi g·ª≠i, Ng∆∞·ªùi nh·∫≠n, S·ªë ti·ªÅn)</li>
                    <li>Click <strong>"‚õèÔ∏è Khai th√°c kh·ªëi"</strong> ƒë·ªÉ ƒë√†o block v·ªõi giao d·ªãch v·ª´a th√™m</li>
                    <li>Click <strong>"‚úîÔ∏è X√°c th·ª±c chu·ªói"</strong> ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa blockchain</li>
                    <li>Click v√†o d√≤ng trong b·∫£ng ƒë·ªÉ xem chi ti·∫øt full hash</li>
                    <li><em>üíæ D·ªØ li·ªáu blockchain s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông (Persistence) - kh√¥ng s·ª£ m·∫•t d·ªØ li·ªáu khi t·∫Øt browser!</em></li>
                </ol>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-number" id="totalBlocks">1</span>
                <span class="stat-label">T·ªïng s·ªë kh·ªëi</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalTxs">0</span>
                <span class="stat-label">T·ªïng giao d·ªãch</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="pendingTxs">0</span>
                <span class="stat-label">Giao d·ªãch ch·ªù</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="chainValid">‚úì</span>
                <span class="stat-label">Tr·∫°ng th√°i chu·ªói</span>
            </div>
        </div>

        <div class="content">
            <div class="card">
                <h2>‚öôÔ∏è ƒêi·ªÅu khi·ªÉn Blockchain</h2>
                <div class="actions">
                    <button onclick="getChain()" class="btn btn-primary">üëÅÔ∏è Xem Blockchain</button>
                    <button onclick="mineBlock()" class="btn btn-success">‚õèÔ∏è Khai th√°c kh·ªëi</button>
                    <button onclick="validateChain()" class="btn btn-info">‚úîÔ∏è X√°c th·ª±c chu·ªói</button>
                    <button onclick="resetChain()" class="btn btn-warning">üîÑ Reset Blockchain</button>
                </div>
            </div>

            <div class="card">
                <h2>‚ûï Th√™m giao d·ªãch m·ªõi</h2>
                <div class="transaction-form">
                    <input type="text" id="sender" placeholder="Ng∆∞·ªùi g·ª≠i" class="input-field">
                    <input type="text" id="receiver" placeholder="Ng∆∞·ªùi nh·∫≠n" class="input-field">
                    <input type="number" id="amount" placeholder="S·ªë ti·ªÅn" class="input-field">
                    <button onclick="addTransaction()" class="btn btn-submit">‚ö° G·ª≠i</button>
                </div>
            </div>
        </div>

        <div class="card full-width" id="blockchainTable">
            <h2>üìä D·ªØ li·ªáu Blockchain (Click v√†o d√≤ng ƒë·ªÉ xem chi ti·∫øt)</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Kh·ªëi</th>
                            <th>Hash</th>
                            <th>Hash tr∆∞·ªõc</th>
                            <th>Th·ªùi gian</th>
                            <th>Giao d·ªãch</th>
                            <th>Nonce</th>
                        </tr>
                    </thead>
                    <tbody id="blockchain">
                        <!-- Blockchain data will be displayed here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for block details -->
    <div id="blockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üìã Chi ti·∫øt Block</h2>
            <div id="blockDetails"></div>
            <button onclick="closeModal()" class="btn btn-primary">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        let blockchainData = [];
        const STORAGE_KEY = 'blockchain_data';

        function toggleInstruction() {
            let instructionBox = document.getElementById("instructionBox");
            if (instructionBox.style.display === "none") {
                instructionBox.style.display = "block";
            } else {
                instructionBox.style.display = "none";
            }
        }

        // Load blockchain from localStorage
        function loadBlockchainFromStorage() {
            try {
                let saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    blockchainData = JSON.parse(saved);
                    updateStatsLocal();
                    displayBlockchain();
                    return true;
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
            }
            return false;
        }

        // Save blockchain to localStorage
        function saveBlockchainToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(blockchainData));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
            }
        }

        // Update stats from local blockchain data (without API call)
        function updateStatsLocal() {
            let totalBlocks = blockchainData.length;
            let totalTransactions = blockchainData.reduce((sum, block) => sum + block.transactions.length, 0);
            // Note: pending_transactions would need server state
            document.getElementById("totalBlocks").textContent = totalBlocks;
            document.getElementById("totalTxs").textContent = totalTransactions;
        }

        // Display blockchain from local data
        function displayBlockchain() {
            let chainTable = document.getElementById("blockchain");
            chainTable.innerHTML = "";
            
            blockchainData.forEach((block, index) => {
                let txText = "Kh√¥ng c√≥ giao d·ªãch";
                if (block.transactions.length > 0) {
                    txText = block.transactions.map(tx => 
                        `${tx.sender} ‚Üí ${tx.receiver}: ${tx.amount}`
                    ).join("<br>");
                }
                let row = `<tr onclick="showBlockDetails(${index})">
                    <td><span class="block-number">${block.index}</span></td>
                    <td><code>${block.hash.substring(0, 8)}...</code></td>
                    <td><code>${block.previous_hash.substring(0, 8)}...</code></td>
                    <td>${block.timestamp}</td>
                    <td>${txText}</td>
                    <td>${block.nonce}</td>
                </tr>`;
                chainTable.innerHTML += row;
            });
        }

        async function getChain() {
            try {
                let response = await fetch("/get_chain");
                let data = await response.json();
                blockchainData = data.chain;
                saveBlockchainToStorage();
                updateStatsLocal();
                displayBlockchain();
                
                async function updateStatsFromServer() {
                    try {
                        let statsResp = await fetch("/get_stats");
                        let statsData = await statsResp.json();
                        document.getElementById("pendingTxs").textContent = statsData.pending_transactions;
                        document.getElementById("chainValid").textContent = statsData.chain_valid ? "‚úì" : "‚úó";
                    } catch (e) { }
                }
                updateStatsFromServer();
                
                // Smooth scroll to blockchain table
                setTimeout(() => {
                    let blockchainTableElement = document.getElementById("blockchainTable");
                    blockchainTableElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } catch (error) {
                alert("L·ªói: " + error);
            }
        }

        function showBlockDetails(index) {
            let block = blockchainData[index];
            if (!block) return;
            
            let txDetails = "Kh√¥ng c√≥ giao d·ªãch";
            if (block.transactions.length > 0) {
                txDetails = block.transactions.map((tx, i) => 
                    `<div class="tx-item"><strong>Giao d·ªãch ${i + 1}:</strong><br>
                    Ng∆∞·ªùi g·ª≠i: ${tx.sender}<br>
                    Ng∆∞·ªùi nh·∫≠n: ${tx.receiver}<br>
                    S·ªë ti·ªÅn: ${tx.amount}<br>
                    Th·ªùi gian: ${tx.timestamp}</div>`
                ).join("");
            }
            
            let details = `
                <div class="block-detail">
                    <p><strong>Ch·ªâ s·ªë Block:</strong> ${block.index}</p>
                    <p><strong>Hash:</strong><br><code class="full-hash">${block.hash}</code></p>
                    <p><strong>Hash tr∆∞·ªõc:</strong><br><code class="full-hash">${block.previous_hash}</code></p>
                    <p><strong>Th·ªùi gian:</strong> ${block.timestamp}</p>
                    <p><strong>Nonce:</strong> ${block.nonce}</p>
                    <p><strong>Proof:</strong> ${block.proof}</p>
                    <p><strong>Giao d·ªãch:</strong></p>
                    ${txDetails}
                </div>
            `;
            
            document.getElementById("blockDetails").innerHTML = details;
            document.getElementById("blockModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("blockModal").style.display = "none";
        }

        async function mineBlock() {
            try {
                let response = await fetch("/mine_block");
                if (response.ok) {
                    alert("‚ú® Kh·ªëi ƒë√£ ƒë∆∞·ª£c ƒë√†o th√†nh c√¥ng!");
                    getChain();
                } else {
                    let error = await response.json();
                    alert("‚ö†Ô∏è " + error.message);
                }
            } catch (error) {
                alert("L·ªói: " + error);
            }
        }

        async function resetChain() {
            if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset blockchain? D·ªØ li·ªáu s·∫Ω b·ªã x√≥a ho√†n to√†n!")) {
                return;
            }
            try {
                let response = await fetch("/reset_chain");
                if (response.ok) {
                    let data = await response.json();
                    blockchainData = data.chain;
                    saveBlockchainToStorage();
                    displayBlockchain();
                    updateStatsLocal();
                    alert("‚ú® Blockchain ƒë√£ ƒë∆∞·ª£c reset!");
                } else {
                    alert("L·ªói reset blockchain");
                }
            } catch (error) {
                alert("L·ªói: " + error);
            }
        }

        async function addTransaction() {
            let sender = document.getElementById("sender").value.trim();
            let receiver = document.getElementById("receiver").value.trim();
            let amount = document.getElementById("amount").value.trim();

            if (!sender || !receiver || !amount) {
                alert("‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                return;
            }

            try {
                let response = await fetch("/add_transaction", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sender, receiver, amount: parseFloat(amount) }),
                });

                if (response.ok) {
                    alert("‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c th√™m!");
                    document.getElementById("sender").value = "";
                    document.getElementById("receiver").value = "";
                    document.getElementById("amount").value = "";
                    getChain();
                } else {
                    let error = await response.json();
                    alert("‚ö†Ô∏è " + error.message);
                }
            } catch (error) {
                alert("L·ªói: " + error);
            }
        }

        async function validateChain() {
            try {
                let response = await fetch("/validate_chain");
                let data = await response.json();
                let message = data.valid ? "‚úì Chu·ªói h·ª£p l·ªá!" : "‚úó Chu·ªói kh√¥ng h·ª£p l·ªá!";
                alert(message);
            } catch (error) {
                alert("L·ªói: " + error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            let modal = document.getElementById("blockModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Load blockchain on page load
        window.addEventListener('load', () => {
            // Try to load from localStorage first
            if (!loadBlockchainFromStorage()) {
                // If no saved data, fetch from server
                getChain();
            } else {
                // Show saved data from localStorage
                console.log("Blockchain loaded from localStorage");
            }
        });
    </script>
</body>
</html>
